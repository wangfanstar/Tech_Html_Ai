<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>PCSå±‚å‚æ•°è¯¦è§£ - äº¤äº’å¼å¯è§†åŒ–</title>  
    <style>  
        * {  
            margin: 0;  
            padding: 0;  
            box-sizing: border-box;  
        }  

        body {  
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;  
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);  
            padding: 20px;  
            min-height: 100vh;  
            color: #333;  
        }  

        .container {  
            max-width: 1600px;  
            margin: 0 auto;  
            background: rgba(255, 255, 255, 0.98);  
            border-radius: 20px;  
            padding: 30px;  
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);  
        }  

        h1 {  
            text-align: center;  
            color: #1e3c72;  
            margin-bottom: 10px;  
            font-size: 2.5em;  
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);  
        }  

        .subtitle {  
            text-align: center;  
            color: #7f8c8d;  
            margin-bottom: 30px;  
            font-size: 1.1em;  
        }  

        .nav-tabs {  
            display: flex;  
            justify-content: center;  
            gap: 10px;  
            margin-bottom: 30px;  
            flex-wrap: wrap;  
        }  

        .tab-btn {  
            padding: 12px 24px;  
            background: #ecf0f1;  
            border: none;  
            border-radius: 8px;  
            cursor: pointer;  
            font-weight: bold;  
            font-size: 0.95em;  
            transition: all 0.3s ease;  
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);  
        }  

        .tab-btn:hover {  
            background: #bdc3c7;  
            transform: translateY(-2px);  
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);  
        }  

        .tab-btn.active {  
            background: linear-gradient(135deg, #3498db, #2980b9);  
            color: white;  
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);  
        }  

        .tab-content {  
            display: none;  
        }  

        .tab-content.active {  
            display: block;  
            animation: fadeIn 0.5s ease;  
        }  

        @keyframes fadeIn {  
            from { opacity: 0; transform: translateY(10px); }  
            to { opacity: 1; transform: translateY(0); }  
        }  

        .section {  
            background: white;  
            border-radius: 12px;  
            padding: 25px;  
            margin-bottom: 25px;  
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);  
        }  

        .section-title {  
            font-size: 1.5em;  
            color: #2c3e50;  
            margin-bottom: 20px;  
            padding-bottom: 10px;  
            border-bottom: 3px solid #3498db;  
            display: flex;  
            align-items: center;  
            gap: 10px;  
        }  

        .controls {  
            display: flex;  
            gap: 15px;  
            margin-bottom: 20px;  
            flex-wrap: wrap;  
            justify-content: center;  
        }  

        .btn {  
            padding: 10px 20px;  
            border: none;  
            border-radius: 6px;  
            font-weight: bold;  
            cursor: pointer;  
            transition: all 0.3s ease;  
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);  
        }  

        .btn-primary {  
            background: linear-gradient(135deg, #3498db, #2980b9);  
            color: white;  
        }  

        .btn-success {  
            background: linear-gradient(135deg, #2ecc71, #27ae60);  
            color: white;  
        }  

        .btn-warning {  
            background: linear-gradient(135deg, #f39c12, #e67e22);  
            color: white;  
        }  

        .btn-danger {  
            background: linear-gradient(135deg, #e74c3c, #c0392b);  
            color: white;  
        }  

        .btn:hover {  
            transform: translateY(-2px);  
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);  
        }  

        .btn:active {  
            transform: translateY(0);  
        }  

        .visualization {  
            background: #2c3e50;  
            border-radius: 8px;  
            padding: 20px;  
            min-height: 300px;  
            position: relative;  
            overflow: hidden;  
            font-family: 'Courier New', monospace;  
            color: #00ff00;  
        }  

        .bit-stream {  
            display: flex;  
            gap: 2px;  
            flex-wrap: wrap;  
            margin-bottom: 15px;  
            font-size: 14px;  
        }  

        .bit {  
            width: 30px;  
            height: 30px;  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            border-radius: 4px;  
            font-weight: bold;  
            transition: all 0.3s ease;  
        }  

        .bit.sync-header {  
            background: #e74c3c;  
            color: white;  
            border: 2px solid #c0392b;  
        }  

        .bit.data {  
            background: #3498db;  
            color: white;  
        }  

        .bit.am-marker {  
            background: #f39c12;  
            color: white;  
            border: 2px solid #e67e22;  
            animation: pulse 1s infinite;  
        }  

        .bit.idle {  
            background: #95a5a6;  
            color: white;  
        }  

        .bit.error {  
            background: #e74c3c;  
            animation: shake 0.5s;  
        }  

        @keyframes pulse {  
            0%, 100% { transform: scale(1); }  
            50% { transform: scale(1.2); }  
        }  

        @keyframes shake {  
            0%, 100% { transform: translateX(0); }  
            25% { transform: translateX(-5px); }  
            75% { transform: translateX(5px); }  
        }  

        .status-panel {  
            background: #ecf0f1;  
            border-radius: 8px;  
            padding: 15px;  
            margin-top: 20px;  
        }  

        .status-item {  
            display: flex;  
            justify-content: space-between;  
            padding: 10px;  
            margin: 5px 0;  
            background: white;  
            border-radius: 6px;  
            border-left: 4px solid #3498db;  
        }  

        .status-item.success {  
            border-left-color: #2ecc71;  
        }  

        .status-item.warning {  
            border-left-color: #f39c12;  
        }  

        .status-item.error {  
            border-left-color: #e74c3c;  
        }  

        .status-label {  
            font-weight: bold;  
            color: #2c3e50;  
        }  

        .status-value {  
            font-family: 'Courier New', monospace;  
            color: #7f8c8d;  
        }  

        .lane-display {  
            display: grid;  
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));  
            gap: 15px;  
            margin-top: 20px;  
        }  

        .lane-card {  
            background: white;  
            border-radius: 8px;  
            padding: 15px;  
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);  
            text-align: center;  
            transition: all 0.3s ease;  
        }  

        .lane-card:hover {  
            transform: translateY(-5px);  
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);  
        }  

        .lane-number {  
            font-size: 1.5em;  
            font-weight: bold;  
            color: #3498db;  
            margin-bottom: 10px;  
        }  

        .lane-status {  
            padding: 8px;  
            border-radius: 6px;  
            margin: 5px 0;  
            font-size: 0.9em;  
        }  

        .lane-status.locked {  
            background: #d4edda;  
            color: #155724;  
            border: 1px solid #c3e6cb;  
        }  

        .lane-status.unlocked {  
            background: #f8d7da;  
            color: #721c24;  
            border: 1px solid #f5c6cb;  
        }  

        .wave-canvas {  
            width: 100%;  
            height: 200px;  
            background: #1a1a1a;  
            border-radius: 8px;  
            margin: 15px 0;  
        }  

        .chart-container {  
            position: relative;  
            height: 300px;  
            margin: 20px 0;  
        }  

        .info-box {  
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);  
            border-left: 5px solid #2196f3;  
            padding: 15px;  
            border-radius: 6px;  
            margin: 15px 0;  
        }  

        .info-box h4 {  
            color: #1565c0;  
            margin-bottom: 10px;  
        }  

        .info-box p {  
            color: #0d47a1;  
            line-height: 1.6;  
        }  

        .code-block {  
            background: #2c3e50;  
            color: #00ff00;  
            padding: 15px;  
            border-radius: 6px;  
            font-family: 'Courier New', monospace;  
            overflow-x: auto;  
            margin: 15px 0;  
            white-space: pre-wrap;  /* å…³é”®ï¼šä¿æŒæ¢è¡Œ */  
            word-wrap: break-word;  /* é•¿å•è¯æ¢è¡Œ */  
            line-height: 1.6;       /* è¡Œé«˜ */  
        }  

        /* AM Pattern ç‰¹æ®Šæ ·å¼ */  
        .am-pattern-display {  
            background: #2c3e50;  
            color: #00ff00;  
            padding: 20px;  
            border-radius: 8px;  
            font-family: 'Courier New', monospace;  
            font-size: 13px;  
            line-height: 2;  
            overflow-x: auto;  
            margin: 15px 0;  
        }  

        .am-pattern-line {  
            display: block;  
            padding: 5px 0;  
            border-left: 3px solid transparent;  
            padding-left: 10px;  
            transition: all 0.3s ease;  
        }  

        .am-pattern-line:hover {  
            background: rgba(52, 152, 219, 0.2);  
            border-left-color: #3498db;  
        }  

        .lane-label {  
            color: #3498db;  
            font-weight: bold;  
        }  

        .pattern-value {  
            color: #2ecc71;  
        }  

        .pattern-inverse {  
            color: #f39c12;  
        }  

        .legend {  
            display: flex;  
            gap: 20px;  
            flex-wrap: wrap;  
            margin: 15px 0;  
            padding: 15px;  
            background: #ecf0f1;  
            border-radius: 6px;  
        }  

        .legend-item {  
            display: flex;  
            align-items: center;  
            gap: 8px;  
        }  

        .legend-color {  
            width: 20px;  
            height: 20px;  
            border-radius: 4px;  
        }  

        .progress-bar {  
            width: 100%;  
            height: 30px;  
            background: #ecf0f1;  
            border-radius: 15px;  
            overflow: hidden;  
            margin: 15px 0;  
        }  

        .progress-fill {  
            height: 100%;  
            background: linear-gradient(90deg, #3498db, #2ecc71);  
            transition: width 0.5s ease;  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            color: white;  
            font-weight: bold;  
        }  

        @media (max-width: 768px) {  
            h1 {  
                font-size: 1.8em;  
            }  
            
            .lane-display {  
                grid-template-columns: 1fr;  
            }  
            
            .nav-tabs {  
                flex-direction: column;  
            }  
            
            .tab-btn {  
                width: 100%;  
            }  
        }  
    </style>  
</head>  
<body>  
    <div class="container">  
        <h1>ğŸ”§ PCSå±‚å‚æ•°è¯¦è§£</h1>  
        <p class="subtitle">Physical Coding Sublayer - äº¤äº’å¼å¯è§†åŒ–æ¼”ç¤º</p>  

        <div class="nav-tabs">  
            <button class="tab-btn active" onclick="switchTab('block-lock')">1. Block Lock</button>  
            <button class="tab-btn" onclick="switchTab('am-lock')">2. AM Lock</button>  
            <button class="tab-btn" onclick="switchTab('deskew')">3. Lane Deskew</button>  
            <button class="tab-btn" onclick="switchTab('ber')">4. BERç›‘æ§</button>  
            <button class="tab-btn" onclick="switchTab('idle')">5. IDLEæ£€æµ‹</button>  
        </div>  

        <!-- Tab 1: Block Lock -->  
        <div id="block-lock" class="tab-content active">  
            <div class="section">  
                <div class="section-title">  
                    <span>ğŸ”</span>  
                    <span>Block Lock (å—åŒæ­¥)</span>  
                </div>  

                <div class="info-box">  
                    <h4>ğŸ“š åŸç†è¯´æ˜</h4>  
                    <p>PCSå±‚ä½¿ç”¨256b/257bç¼–ç ï¼šæ¯256 bitsæ•°æ®å‰åŠ 1 bitåŒæ­¥å¤´(Sync Header)ã€‚  
                    Block Lockå°±æ˜¯è¯†åˆ«å¹¶é”å®šè¿™äº›åŒæ­¥å¤´çš„è¿‡ç¨‹ã€‚</p>  
                    <p><strong>Sync Headerè§„åˆ™ï¼š</strong> 0 = æ•°æ®å—, 1 = æ§åˆ¶å—</p>  
                </div>  

                <div class="controls">  
                    <button class="btn btn-primary" onclick="startBlockLock()">ğŸš€ å¼€å§‹æ£€æµ‹</button>  
                    <button class="btn btn-warning" onclick="injectError('block')">âš ï¸ æ³¨å…¥é”™è¯¯</button>  
                    <button class="btn btn-danger" onclick="resetBlockLock()">ğŸ”„ é‡ç½®</button>  
                </div>  

                <div class="visualization" id="blockLockViz">  
                    <div style="color: #00ff00; margin-bottom: 10px;">æ­£åœ¨ç­‰å¾…å¯åŠ¨...</div>  
                </div>  

                <div class="legend">  
                    <div class="legend-item">  
                        <div class="legend-color" style="background: #e74c3c;"></div>  
                        <span>Sync Header (0æˆ–1)</span>  
                    </div>  
                    <div class="legend-item">  
                        <div class="legend-color" style="background: #3498db;"></div>  
                        <span>Data Block (256 bits)</span>  
                    </div>  
                    <div class="legend-item">  
                        <div class="legend-color" style="background: #f39c12;"></div>  
                        <span>Control Block (256 bits)</span>  
                    </div>  
                </div>  

                <div class="status-panel" id="blockLockStatus">  
                    <div class="status-item">  
                        <span class="status-label">æ£€æµ‹çŠ¶æ€:</span>  
                        <span class="status-value" id="blockLockState">LOCK_INIT</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">è¿ç»­æ­£ç¡®è®¡æ•°:</span>  
                        <span class="status-value" id="blockCorrectCount">0 / 64</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">é”™è¯¯è®¡æ•°:</span>  
                        <span class="status-value" id="blockErrorCount">0</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">é”å®šçŠ¶æ€:</span>  
                        <span class="status-value" id="blockLockResult">æœªé”å®š</span>  
                    </div>  
                </div>  

                <div class="code-block">// Block Lock çŠ¶æ€æœº  
[LOCK_INIT] åˆå§‹çŠ¶æ€  
    â†“ æ£€æµ‹sync header  
[LOCK_ACQUIRED] æ‰¾åˆ°sync pattern  
    â†“ è¿ç»­64ä¸ªæ­£ç¡®  
[LOCK_VALID] âœ“ é”å®šæˆåŠŸ  
    â†“ è¿ç»­64ä¸ªé”™è¯¯  
[LOCK_LOST] âœ— å¤±å»é”å®š</div>  
            </div>  
        </div>  

        <!-- Tab 2: AM Lock -->  
        <div id="am-lock" class="tab-content">  
            <div class="section">  
                <div class="section-title">  
                    <span>ğŸ“</span>  
                    <span>AM Lock (å¯¹é½æ ‡è®°é”å®š)</span>  
                </div>  

                <div class="info-box">  
                    <h4>ğŸ“š åŸç†è¯´æ˜</h4>  
                    <p>Alignment Marker (AM) æ˜¯å‘¨æœŸæ€§æ’å…¥çš„ç‰¹æ®Šæ ‡è®°ï¼Œç”¨äºlaneå¯¹é½ã€‚</p>  
                    <p><strong>æ’å…¥å‘¨æœŸï¼š</strong>æ¯16383ä¸ªblockæ’å…¥1ä¸ªAM (çº¦40Î¼s)</p>  
                    <p><strong>AMæ¨¡å¼ï¼š</strong>æ¯æ¡laneæœ‰å”¯ä¸€çš„patternï¼Œç”¨äºè¯†åˆ«å’ŒåŒæ­¥</p>  
                </div>  

                <div class="controls">  
                    <button class="btn btn-primary" onclick="startAMLock()">ğŸš€ å¼€å§‹æ£€æµ‹AM</button>  
                    <button class="btn btn-success" onclick="showAMPattern()">ğŸ“‹ æ˜¾ç¤ºAMæ¨¡å¼</button>  
                    <button class="btn btn-warning" onclick="injectError('am')">âš ï¸ AMç¼ºå¤±</button>  
                    <button class="btn btn-danger" onclick="resetAMLock()">ğŸ”„ é‡ç½®</button>  
                </div>  

                <div class="visualization" id="amLockViz">  
                    <div style="color: #00ff00;">AMæ£€æµ‹å¯è§†åŒ–åŒºåŸŸ</div>  
                </div>  

                <div class="status-panel" id="amLockStatus">  
                    <div class="status-item">  
                        <span class="status-label">AMæ£€æµ‹çŠ¶æ€:</span>  
                        <span class="status-value" id="amLockState">AM_INIT</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">æ£€æµ‹åˆ°çš„AM:</span>  
                        <span class="status-value" id="amFoundCount">0 / 4</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">ä¸‹æ¬¡é¢„æœŸä½ç½®:</span>  
                        <span class="status-value" id="amNextPosition">Block 16383</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">AM LockçŠ¶æ€:</span>  
                        <span class="status-value" id="amLockResult">æœªé”å®š</span>  
                    </div>  
                </div>  

                <!-- ä¿®å¤åçš„AM Patternæ˜¾ç¤º -->  
                <div class="am-pattern-display" id="amPatternDisplay">  
<span style="color: #95a5a6;">// 800G AM Patterns (IEEE 802.3bs)</span>  

<span class="am-pattern-line"><span class="lane-label">Lane 0:</span> <span class="pattern-value">0x90_76_47_CB</span> + inverse <span class="pattern-inverse">(0x6F_89_B8_34)</span></span>  
<span class="am-pattern-line"><span class="lane-label">Lane 1:</span> <span class="pattern-value">0xF0_C4_E6_1B</span> + inverse <span class="pattern-inverse">(0x0F_3B_19_E4)</span></span>  
<span class="am-pattern-line"><span class="lane-label">Lane 2:</span> <span class="pattern-value">0xC5_FB_65_9A</span> + inverse <span class="pattern-inverse">(0x3A_04_9A_65)</span></span>  
<span class="am-pattern-line"><span class="lane-label">Lane 3:</span> <span class="pattern-value">0xA2_79_3D_8C</span> + inverse <span class="pattern-inverse">(0x5D_86_C2_73)</span></span>  
<span class="am-pattern-line"><span class="lane-label">Lane 4:</span> <span class="pattern-value">0xE1_5A_2B_67</span> + inverse <span class="pattern-inverse">(0x1E_A5_D4_98)</span></span>  
<span class="am-pattern-line"><span class="lane-label">Lane 5:</span> <span class="pattern-value">0xFF_49_08_B5</span> + inverse <span class="pattern-inverse">(0x00_B6_F7_4A)</span></span>  
<span class="am-pattern-line"><span class="lane-label">Lane 6:</span> <span class="pattern-value">0xC8_6C_97_F3</span> + inverse <span class="pattern-inverse">(0x37_93_68_0C)</span></span>  
<span class="am-pattern-line"><span class="lane-label">Lane 7:</span> <span class="pattern-value">0xD4_A5_F0_1C</span> + inverse <span class="pattern-inverse">(0x2B_5A_0F_E3)</span></span>  

<span style="color: #95a5a6;">// æ¯æ¡laneä½¿ç”¨å”¯ä¸€çš„AM patternè¿›è¡Œè¯†åˆ«  
// AM + inverse å…±256 bitsï¼Œç”¨äºå¯é æ£€æµ‹</span>  
                </div>  

                <div class="progress-bar">  
                    <div class="progress-fill" id="amProgress" style="width: 0%;">0%</div>  
                </div>  
            </div>  
        </div>  

        <!-- Tab 3: Lane Deskew -->  
        <div id="deskew" class="tab-content">  
            <div class="section">  
                <div class="section-title">  
                    <span>âš–ï¸</span>  
                    <span>Lane Deskew (é€šé“å¯¹é½)</span>  
                </div>  

                <div class="info-box">  
                    <h4>ğŸ“š åŸç†è¯´æ˜</h4>  
                    <p>800Gä½¿ç”¨8æ¡ç‰©ç†laneå¹¶è¡Œä¼ è¾“ï¼Œç”±äºèµ°çº¿é•¿åº¦å·®å¼‚ï¼Œå„laneåˆ°è¾¾æ—¶é—´ä¸åŒã€‚</p>  
                    <p><strong>Skewå®¹å¿åº¦ï¼š</strong>æœ€å¤§20ns</p>  
                    <p><strong>å¯¹é½æ–¹æ³•ï¼š</strong>ä½¿ç”¨FIFOç¼“å†²å™¨å»¶è¿Ÿè¾ƒå¿«çš„lane</p>  
                </div>  

                <div class="controls">  
                    <button class="btn btn-primary" onclick="startDeskew()">ğŸš€ å¼€å§‹å¯¹é½</button>  
                    <button class="btn btn-success" onclick="randomizeSkew()">ğŸ² éšæœºSkew</button>  
                    <button class="btn btn-warning" onclick="setLargeSkew()">âš ï¸ å¤§Skew(>20ns)</button>  
                    <button class="btn btn-danger" onclick="resetDeskew()">ğŸ”„ é‡ç½®</button>  
                </div>  

                <div class="lane-display" id="laneDisplay">  
                    <!-- 8ä¸ªlaneå¡ç‰‡å°†åœ¨è¿™é‡Œç”Ÿæˆ -->  
                </div>  

                <div class="visualization" id="deskewViz" style="min-height: 400px;">  
                    <canvas id="deskewCanvas" class="wave-canvas"></canvas>  
                </div>  

                <div class="status-panel" id="deskewStatus">  
                    <div class="status-item">  
                        <span class="status-label">æœ€å¤§Skew:</span>  
                        <span class="status-value" id="maxSkew">0 ns</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">DeskewçŠ¶æ€:</span>  
                        <span class="status-value" id="deskewState">æœªå¼€å§‹</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">å¯¹é½å®Œæˆ:</span>  
                        <span class="status-value" id="deskewProgress">0 / 8 lanes</span>  
                    </div>  
                </div>  

                <div class="code-block">// Deskewç®—æ³•  
Step 1: æ£€æµ‹æ¯æ¡laneçš„AMåˆ°è¾¾æ—¶é—´  
Step 2: æ‰¾åˆ°æœ€æ™šåˆ°è¾¾çš„lane (max_delay)  
Step 3: è®¡ç®—æ¯æ¡laneçš„FIFOå»¶è¿Ÿ  
    lane_delay[i] = max_delay - lane_arrival[i]  
Step 4: é€šè¿‡FIFOå®ç°å»¶è¿Ÿ  
    if max_skew <= 20ns: DeskewæˆåŠŸ âœ“  
    else: Deskewå¤±è´¥ âœ—</div>  
            </div>  
        </div>  

        <!-- Tab 4: BER Monitor -->  
        <div id="ber" class="tab-content">  
            <div class="section">  
                <div class="section-title">  
                    <span>ğŸ“Š</span>  
                    <span>BERç›‘æ§ (è¯¯ç ç‡æ£€æµ‹)</span>  
                </div>  

                <div class="info-box">  
                    <h4>ğŸ“š åŸç†è¯´æ˜</h4>  
                    <p>BER (Bit Error Rate) = é”™è¯¯bits / æ€»bits</p>  
                    <p><strong>è¦æ±‚ï¼š</strong>FECå‰ BER < 10<sup>-12</sup></p>  
                    <p><strong>æ£€æµ‹æ–¹æ³•ï¼š</strong>BIP-8 (Bit Interleaved Parity) æˆ– PRBSæµ‹è¯•</p>  
                </div>  

                <div class="controls">  
                    <button class="btn btn-primary" onclick="startBERMonitor()">ğŸš€ å¼€å§‹ç›‘æ§</button>  
                    <button class="btn btn-success" onclick="setBERLevel('good')">âœ“ è‰¯å¥½ä¿¡å·</button>  
                    <button class="btn btn-warning" onclick="setBERLevel('warning')">âš ï¸ è­¦å‘Šçº§åˆ«</button>  
                    <button class="btn btn-danger" onclick="setBERLevel('critical')">âœ— ä¸¥é‡çº§åˆ«</button>  
                </div>  

                <div class="chart-container">  
                    <canvas id="berChart"></canvas>  
                </div>  

                <div class="status-panel" id="berStatus">  
                    <div class="status-item">  
                        <span class="status-label">å½“å‰BER:</span>  
                        <span class="status-value" id="currentBER">0</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">é”™è¯¯Bits (1ç§’):</span>  
                        <span class="status-value" id="errorBits">0</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">æ€»Bits (1ç§’):</span>  
                        <span class="status-value" id="totalBits">8.0 Ã— 10Â¹Â¹</span>  
                    </div>  
                    <div class="status-item">  
                        <span class="status-label">BERçŠ¶æ€:</span>  
                        <span class="status-value" id="berState">æ­£å¸¸</span>  
                    </div>  
                </div>  

                <div class="code-block">// BERè®¡ç®—ç¤ºä¾‹  
800Gbpsé€Ÿç‡ä¸‹ï¼š  
- æ¯ç§’ä¼ è¾“: 8 Ã— 10^11 bits  
- è¦æ±‚BER < 10^-12  
- å…è®¸é”™è¯¯: < 800 bits/ç§’  

BIP-8æ ¡éªŒï¼š  
- å°†256bitsåˆ†æˆ8ç»„  
- æ¯ç»„è®¡ç®—å¶æ ¡éªŒ  
- æ¯”å¯¹å‘é€å’Œæ¥æ”¶çš„BIP  
- é”™è¯¯ä½æ•° = BERä¼°ç®—å€¼</div>  

                <div class="visualization" id="berViz" style="min-height: 200px;">  
                    <div style="color: #00ff00; font-size: 24px; text-align: center; padding: 50px;">  
                        å®æ—¶BERæ›²çº¿æ˜¾ç¤ºåŒºåŸŸ  
                    </div>  
                </div>  
            </div>  
        </div>  

        <!-- Tab 5: IDLE Detection -->  
        <div id="idle" class="tab-content">  
            <div class="section">  
                <div class="section-title">  
                    <span>â¸ï¸</span>  
                    <span>IDLEæ£€æµ‹ (ç©ºé—²ç æ£€æµ‹)</span>  
                </div>  

                <div class="info-box">  
                    <h4>ğŸ“š åŸç†è¯´æ˜</h4>  
                    <p>IDLEæ˜¯PCSå±‚åœ¨æ— æ•°æ®æ—¶å‘é€çš„ç‰¹æ®Šæ§åˆ¶ç ï¼Œç”¨äºä¿æŒé“¾è·¯æ´»è·ƒã€‚</p>  
                    <p><strong>IDLEæ ¼å¼ï¼š</strong>[Sync:1][Control Type:0x1E][8 bytes data]</p>  
                    <p><strong>ä½œç”¨ï¼š</strong>æ—¶é’ŸåŒæ­¥ã€é“¾è·¯ä¿æ´»ã€å¸§é—´éš™å¡«å……</p>  
                </div>  

                <div class="controls">  
                    <button class="btn btn-primary" onclick="startIDLEDetection()">ğŸš€ å¼€å§‹æ£€æµ‹</button>  
                    <button class="btn btn-success" onclick="sendDataFrames()">ğŸ“¤ å‘é€æ•°æ®å¸§</button>  
                    <button class="btn btn-warning" onclick="sendIDLEOnly()">â¸ï¸ ä»…å‘é€IDLE</button>  
                    <button class="btn btn-danger" onclick="resetIDLE()">
					ğŸ”„ é‡ç½®</button>
                </div>

                <div class="visualization" id="idleViz">
                    <div style="color: #00ff00;">ç­‰å¾…å¼€å§‹IDLEæ£€æµ‹...</div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #95a5a6;"></div>
                        <span>IDLE Block</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>Data Block</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2ecc71;"></div>
                        <span>Preamble/SFD</span>
                    </div>
                </div>

                <div class="status-panel" id="idleStatus">
                    <div class="status-item">
                        <span class="status-label">IDLEæ£€æµ‹:</span>
                        <span class="status-value" id="idleDetected">æœªæ£€æµ‹</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">è¿ç»­IDLEæ•°:</span>
                        <span class="status-value" id="consecutiveIdle">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">IDLEæ€»æ•° (1ç§’):</span>
                        <span class="status-value" id="totalIdle">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">é”™è¯¯IDLE:</span>
                        <span class="status-value" id="errorIdle">0</span>
                    </div>
                </div>

                <div class="code-block">// IDLEæ ¼å¼ (256 bits)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Sync: 1 â”‚ Type: 0x1E   â”‚ Idle Data: 0x00  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// å…¸å‹æµç¨‹
[Data Frame] â†’ [IFG (12B IDLE)] â†’ [Data Frame]
æ— æ•°æ®æ—¶ï¼š
[IDLE][IDLE][IDLE][IDLE]...æŒç»­å‘é€

// IDLEæ£€æµ‹æ¡ä»¶
- Sync header = 1 (æ§åˆ¶å—)
- Control type = 0x1E
- è¿ç»­æ¥æ”¶ â‰¥ 16ä¸ªIDLE â†’ æ£€æµ‹æˆåŠŸ</div>
            </div>
        </div>

    </div>

    <script>
        // å…¨å±€å˜é‡
        let blockLockInterval = null;
        let amLockInterval = null;
        let deskewInterval = null;
        let berInterval = null;
        let idleInterval = null;

        let blockLockData = {
            state: 'LOCK_INIT',
            correctCount: 0,
            errorCount: 0,
            locked: false,
            currentBlock: 0
        };

        let amLockData = {
            state: 'AM_INIT',
            foundCount: 0,
            blockCount: 0,
            nextPosition: 16383,
            locked: false
        };

        let deskewData = {
            lanes: Array(8).fill().map((_, i) => ({
                id: i,
                skew: 0,
                delay: 0,
                locked: false,
                arrivalTime: 0
            })),
            maxSkew: 0,
            aligned: false
        };

        let berData = {
            history: [],
            currentBER: 0,
            errorBits: 0,
            totalBits: 8e11,
            chart: null
        };

        let idleData = {
            detected: false,
            consecutiveCount: 0,
            totalCount: 0,
            errorCount: 0,
            blocks: []
        };

        // Tabåˆ‡æ¢
        function switchTab(tabId) {
            // åœæ­¢æ‰€æœ‰åŠ¨ç”»
            stopAllAnimations();

            // éšè—æ‰€æœ‰tabå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®activeçŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„tab
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function stopAllAnimations() {
            clearInterval(blockLockInterval);
            clearInterval(amLockInterval);
            clearInterval(deskewInterval);
            clearInterval(berInterval);
            clearInterval(idleInterval);
        }

        // ==================== Block Lock ====================
        function startBlockLock() {
            resetBlockLock();
            blockLockData.state = 'LOCK_ACQUIRED';
            
            blockLockInterval = setInterval(() => {
                generateBlockLockStream();
                updateBlockLockStatus();
            }, 200);
        }

        function generateBlockLockStream() {
            const viz = document.getElementById('blockLockViz');
            let html = '<div class="bit-stream">';
            
            for (let i = 0; i < 10; i++) {
                const syncHeader = Math.random() > 0.05 ? (Math.random() > 0.5 ? 0 : 1) : 'X';
                const isError = syncHeader === 'X';
                
                // Sync Header
                html += `<div class="bit ${isError ? 'error' : 'sync-header'}" 
                         style="font-size: 16px; width: 40px; height: 40px;">
                         ${syncHeader}
                         </div>`;
                
                // Data block (ç®€åŒ–æ˜¾ç¤º)
                const blockType = syncHeader === 1 ? 'am-marker' : 'data';
                html += `<div class="bit ${blockType}" 
                         style="width: 200px; font-size: 12px;">
                         ${syncHeader === 1 ? 'CTRL 256b' : 'DATA 256b'}
                         </div>`;
                
                if (isError) {
                    blockLockData.errorCount++;
                    blockLockData.correctCount = 0;
                } else {
                    blockLockData.correctCount++;
                }
                
                blockLockData.currentBlock++;
            }
            
            html += '</div>';
            
            // æ˜¾ç¤ºå½“å‰blockä¿¡æ¯
            html += `<div style="color: #00ff00; margin-top: 15px;">
                     å½“å‰Block: ${blockLockData.currentBlock}<br>
                     çŠ¶æ€: ${blockLockData.state}<br>
                     ${blockLockData.locked ? 'âœ“ Block Lock æˆåŠŸ!' : 'æ£€æµ‹ä¸­...'}
                     </div>`;
            
            viz.innerHTML = html;
            
            // æ£€æŸ¥æ˜¯å¦é”å®š
            if (blockLockData.correctCount >= 64 && !blockLockData.locked) {
                blockLockData.locked = true;
                blockLockData.state = 'LOCK_VALID';
            }
        }

        function updateBlockLockStatus() {
            document.getElementById('blockLockState').textContent = blockLockData.state;
            document.getElementById('blockCorrectCount').textContent = 
                `${blockLockData.correctCount} / 64`;
            document.getElementById('blockErrorCount').textContent = blockLockData.errorCount;
            document.getElementById('blockLockResult').textContent = 
                blockLockData.locked ? 'âœ“ å·²é”å®š' : 'æœªé”å®š';
            
            // æ›´æ–°çŠ¶æ€æ ·å¼
            const stateItem = document.querySelectorAll('#blockLockStatus .status-item')[3];
            if (blockLockData.locked) {
                stateItem.classList.remove('error');
                stateItem.classList.add('success');
            }
        }

        function injectError(type) {
            if (type === 'block') {
                blockLockData.correctCount = Math.max(0, blockLockData.correctCount - 10);
                blockLockData.errorCount += 10;
            } else if (type === 'am') {
                amLockData.foundCount = 0;
                amLockData.state = 'AM_LOST';
            }
        }

        function resetBlockLock() {
            clearInterval(blockLockInterval);
            blockLockData = {
                state: 'LOCK_INIT',
                correctCount: 0,
                errorCount: 0,
                locked: false,
                currentBlock: 0
            };
            document.getElementById('blockLockViz').innerHTML = 
                '<div style="color: #00ff00; margin-bottom: 10px;">æ­£åœ¨ç­‰å¾…å¯åŠ¨...</div>';
            updateBlockLockStatus();
        }

        // ==================== AM Lock ====================
        function startAMLock() {
            resetAMLock();
            amLockData.state = 'AM_SEARCHING';
            
            amLockInterval = setInterval(() => {
                generateAMLockStream();
                updateAMLockStatus();
            }, 500);
        }

        function generateAMLockStream() {
            const viz = document.getElementById('amLockViz');
            let html = '<div style="color: #00ff00; margin-bottom: 15px;">';
            html += `Blockè®¡æ•°: ${amLockData.blockCount}<br>`;
            html += `æ£€æµ‹çŠ¶æ€: ${amLockData.state}<br><br>`;
            html += '</div>';
            
            html += '<div class="bit-stream">';
            
            // æ¨¡æ‹Ÿblockæµ
            for (let i = 0; i < 20; i++) {
                const isAM = (amLockData.blockCount % 16383) === 0 && amLockData.blockCount > 0;
                
                if (isAM) {
                    // AM marker
                    html += `<div class="bit am-marker" 
                             style="width: 100px; font-size: 12px;">
                             AM[${amLockData.blockCount}]
                             </div>`;
                    
                    // æ£€æµ‹åˆ°AM
                    if (Math.random() > 0.1) { // 90%æ­£ç¡®ç‡
                        amLockData.foundCount++;
                        if (amLockData.foundCount >= 4 && !amLockData.locked) {
                            amLockData.locked = true;
                            amLockData.state = 'AM_LOCKED';
                        }
                    } else {
                        amLockData.foundCount = 0;
                    }
                } else {
                    html += `<div class="bit data" style="width: 50px; font-size: 10px;">
                             ${amLockData.blockCount}
                             </div>`;
                }
                
                amLockData.blockCount++;
            }
            
            html += '</div>';
            
            if (amLockData.locked) {
                html += `<div style="color: #2ecc71; margin-top: 20px; font-size: 18px;">
                         âœ“ AM Lock æˆåŠŸ! å·²æ£€æµ‹åˆ°${amLockData.foundCount}ä¸ªè¿ç»­AM
                         </div>`;
            }
            
            viz.innerHTML = html;
        }

        function updateAMLockStatus() {
            document.getElementById('amLockState').textContent = amLockData.state;
            document.getElementById('amFoundCount').textContent = 
                `${Math.min(amLockData.foundCount, 4)} / 4`;
            document.getElementById('amNextPosition').textContent = 
                `Block ${amLockData.blockCount + (16383 - (amLockData.blockCount % 16383))}`;
            document.getElementById('amLockResult').textContent = 
                amLockData.locked ? 'âœ“ å·²é”å®š' : 'æœªé”å®š';
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = Math.min(100, (amLockData.foundCount / 4) * 100);
            document.getElementById('amProgress').style.width = progress + '%';
            document.getElementById('amProgress').textContent = Math.round(progress) + '%';
            
            // æ›´æ–°çŠ¶æ€æ ·å¼
            const stateItem = document.querySelectorAll('#amLockStatus .status-item')[3];
            if (amLockData.locked) {
                stateItem.classList.add('success');
            }
        }

        function showAMPattern() {
            // æ»šåŠ¨åˆ°AM Patternæ˜¾ç¤ºåŒºåŸŸå¹¶é«˜äº®
            const patternDiv = document.getElementById('amPatternDisplay');
            patternDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // é—ªçƒæ•ˆæœ
            let count = 0;
            const flashInterval = setInterval(() => {
                patternDiv.style.boxShadow = count % 2 === 0 ? 
                    '0 0 20px rgba(52, 152, 219, 0.8)' : 
                    '0 0 5px rgba(52, 152, 219, 0.3)';
                count++;
                if (count >= 6) {
                    clearInterval(flashInterval);
                    patternDiv.style.boxShadow = 'none';
                }
            }, 200);
        }

        function resetAMLock() {
            clearInterval(amLockInterval);
            amLockData = {
                state: 'AM_INIT',
                foundCount: 0,
                blockCount: 0,
                nextPosition: 16383,
                locked: false
            };
            document.getElementById('amLockViz').innerHTML = 
                '<div style="color: #00ff00;">AMæ£€æµ‹å¯è§†åŒ–åŒºåŸŸ</div>';
            updateAMLockStatus();
        }

        // ==================== Lane Deskew ====================
        function initLaneDisplay() {
            const container = document.getElementById('laneDisplay');
            let html = '';
            
            for (let i = 0; i < 8; i++) {
                html += `
                <div class="lane-card">
                    <div class="lane-number">Lane ${i}</div>
                    <div class="lane-status unlocked" id="lane-${i}-status">
                        æœªå¯¹é½
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #34495e;">
                        <div>Skew: <span id="lane-${i}-skew">0</span> ns</div>
                        <div>Delay: <span id="lane-${i}-delay">0</span> ns</div>
                        <div>åˆ°è¾¾: <span id="lane-${i}-arrival">0</span> ns</div>
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function startDeskew() {
            // éšæœºç”Ÿæˆskew
            randomizeSkew();
            
            setTimeout(() => {
                performDeskew();
            }, 1000);
        }

        function randomizeSkew() {
            const baseTime = 1000; // åŸºå‡†æ—¶é—´ 1000ns
            
            for (let i = 0; i < 8; i++) {
                const skew = Math.random() * 18; // 0-18nséšæœºskew
                deskewData.lanes[i].arrivalTime = baseTime + skew;
                deskewData.lanes[i].skew = skew;
                deskewData.lanes[i].locked = false;
                
                updateLaneDisplay(i);
            }
            
            calculateMaxSkew();
            drawDeskewWave();
        }

        function setLargeSkew() {
            const baseTime = 1000;
            
            for (let i = 0; i < 8; i++) {
                const skew = Math.random() * 25; // 0-25nsï¼Œè¶…è¿‡é˜ˆå€¼
                deskewData.lanes[i].arrivalTime = baseTime + skew;
                deskewData.lanes[i].skew = skew;
                deskewData.lanes[i].locked = false;
                
                updateLaneDisplay(i);
            }
            
            calculateMaxSkew();
            drawDeskewWave();
            
            document.getElementById('deskewState').textContent = 'âš ï¸ Skewè¶…è¿‡20nsé˜ˆå€¼!';
            document.querySelectorAll('#deskewStatus .status-item')[1].classList.add('error');
        }

        function performDeskew() {
            // æ‰¾åˆ°æœ€æ™šåˆ°è¾¾çš„lane
            let maxArrival = Math.max(...deskewData.lanes.map(l => l.arrivalTime));
            
            // è®¡ç®—æ¯æ¡laneéœ€è¦çš„å»¶è¿Ÿ
            deskewData.lanes.forEach((lane, i) => {
                lane.delay = maxArrival - lane.arrivalTime;
            });
            
            // åŠ¨ç”»æ˜¾ç¤ºå¯¹é½è¿‡ç¨‹
            let completed = 0;
            const interval = setInterval(() => {
                if (completed < 8) {
                    deskewData.lanes[completed].locked = true;
                    updateLaneDisplay(completed);
                    completed++;
                    
                    document.getElementById('deskewProgress').textContent = 
                        `${completed} / 8 lanes`;
                } else {
                    clearInterval(interval);
                    deskewData.aligned = true;
                    document.getElementById('deskewState').textContent = 'âœ“ å¯¹é½æˆåŠŸ';
                    document.querySelectorAll('#deskewStatus .status-item')[1].classList.add('success');
                }
                
                drawDeskewWave();
            }, 300);
        }

        function calculateMaxSkew() {
            const skews = deskewData.lanes.map(l => l.skew);
            deskewData.maxSkew = Math.max(...skews) - Math.min(...skews);
            
            document.getElementById('maxSkew').textContent = 
                deskewData.maxSkew.toFixed(2) + ' ns';
            
            const statusItem = document.querySelectorAll('#deskewStatus .status-item')[0];
            if (deskewData.maxSkew > 20) {
                statusItem.classList.add('error');
                statusItem.classList.remove('success');
            } else {
                statusItem.classList.add('success');
                statusItem.classList.remove('error');
            }
        }

        function updateLaneDisplay(laneId) {
            const lane = deskewData.lanes[laneId];
            
            document.getElementById(`lane-${laneId}-skew`).textContent = 
                lane.skew.toFixed(2);
            document.getElementById(`lane-${laneId}-delay`).textContent = 
                lane.delay.toFixed(2);
            document.getElementById(`lane-${laneId}-arrival`).textContent = 
                lane.arrivalTime.toFixed(2);
            
            const statusDiv = document.getElementById(`lane-${laneId}-status`);
            if (lane.locked) {
                statusDiv.className = 'lane-status locked';
                statusDiv.textContent = 'âœ“ å·²å¯¹é½';
            } else {
                statusDiv.className = 'lane-status unlocked';
                statusDiv.textContent = 'æœªå¯¹é½';
            }
        }

        function drawDeskewWave() {
            const canvas = document.getElementById('deskewCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', 
                           '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];
            
            const baseX = 50;
            const spacing = 20;
            
            deskewData.lanes.forEach((lane, i) => {
                const y = 20 + i * spacing;
                const arrivalX = baseX + (lane.arrivalTime - 1000) * 10; // scale for display
                const alignedX = deskewData.aligned ? baseX + deskewData.maxSkew * 10 : arrivalX;
                
                // ç»˜åˆ¶laneçº¿
                ctx.strokeStyle = colors[i];
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(deskewData.aligned ? alignedX : arrivalX, y);
                ctx.stroke();
                
                // ç»˜åˆ¶åˆ°è¾¾ç‚¹
                ctx.fillStyle = colors[i];
                ctx.beginPath();
                ctx.arc(arrivalX, y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // å¦‚æœå·²å¯¹é½ï¼Œç»˜åˆ¶å¯¹é½çº¿
                if (deskewData.aligned) {
                    ctx.strokeStyle = '#2ecc71';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(alignedX, y);
                    ctx.lineTo(alignedX + 50, y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // æ ‡ç­¾
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px monospace';
                ctx.fillText(`L${i}`, 5, y + 4);
            });
            
            // ç»˜åˆ¶æ—¶é—´è½´
            ctx.strokeStyle = '#7f8c8d';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(baseX, 0);
            ctx.lineTo(baseX, canvas.height);
            ctx.stroke();
            
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '10px monospace';
            ctx.fillText('T=0', baseX - 15, canvas.height - 5);
        }

        function resetDeskew() {
            clearInterval(deskewInterval);
            deskewData = {
                lanes: Array(8).fill().map((_, i) => ({
                    id: i,
                    skew: 0,
                    delay: 0,
                    locked: false,
                    arrivalTime: 0
                })),
                maxSkew: 0,
                aligned: false
            };
            
            initLaneDisplay();
            
            const canvas = document.getElementById('deskewCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            document.getElementById('maxSkew').textContent = '0 ns';
            document.getElementById('deskewState').textContent = 'æœªå¼€å§‹';
            document.getElementById('deskewProgress').textContent = '0 / 8 lanes';
            
            // æ¸…é™¤çŠ¶æ€æ ·å¼
            document.querySelectorAll('#deskewStatus .status-item').forEach(item => {
                item.classList.remove('success', 'error');
            });
        }

        // ==================== BER Monitor ====================
        function startBERMonitor() {
            berData.history = [];
            setBERLevel('good');
            
            berInterval = setInterval(() => {
                updateBERData();
                drawBERChart();
            }, 1000);
        }

        function updateBERData() {
            // æ ¹æ®å½“å‰çº§åˆ«ç”ŸæˆBERæ•°æ®
            const now = Date.now();
            berData.history.push({
                time: now,
                ber: berData.currentBER
            });
            
            // ä¿æŒæœ€è¿‘60ä¸ªæ•°æ®ç‚¹
            if (berData.history.length > 60) {
                berData.history.shift();
            }
            
            updateBERStatus();
        }

        function setBERLevel(level) {
            switch(level) {
                case 'good':
                    berData.currentBER = (Math.random() * 5 + 1) * 1e-13;
                    berData.errorBits = Math.floor(berData.currentBER * berData.totalBits);
                    break;
                case 'warning':
                    berData.currentBER = (Math.random() * 5 + 5) * 1e-11;
                    berData.errorBits = Math.floor(berData.currentBER * berData.totalBits);
                    break;
                case 'critical':
                    berData.currentBER = (Math.random() * 5 + 1) * 1e-9;
                    berData.errorBits = Math.floor(berData.currentBER * berData.totalBits);
                    break;
            }
        }

        function updateBERStatus() {
            // æ ¼å¼åŒ–BERæ˜¾ç¤º
            const berStr = berData.currentBER.toExponential(2);
            document.getElementById('currentBER').textContent = berStr;
            document.getElementById('errorBits').textContent = 
                berData.errorBits.toLocaleString();
            document.getElementById('totalBits').textContent = '8.0 Ã— 10Â¹Â¹';
            
            // åˆ¤æ–­çŠ¶æ€
            let state = 'âœ“ æ­£å¸¸';
            let stateClass = 'success';
            if (berData.currentBER > 1e-10) {
                state = 'âš ï¸ è­¦å‘Š';
                stateClass = 'warning';
            }
            if (berData.currentBER > 1e-9) {
                state = 'âœ— ä¸¥é‡';
                stateClass = 'error';
            }
            
            document.getElementById('berState').textContent = state;
            const statusItems = document.querySelectorAll('#berStatus .status-item');
            statusItems[3].className = `status-item ${stateClass}`;
        }

        function drawBERChart() {
            const viz = document.getElementById('berViz');
            
            if (berData.history.length === 0) return;
            
            let html = '<div style="color: #00ff00; padding: 20px;">';
            html += '<div style="font-size: 18px; margin-bottom: 15px;">å®æ—¶BERæ›²çº¿</div>';
            
            // ç®€å•çš„ASCIIå›¾è¡¨
            const maxBER = Math.max(...berData.history.map(d => d.ber));
            const height = 10;
            
            for (let row = height; row >= 0; row--) {
                const threshold = (maxBER / height) * row;
                html += '<div style="display: flex; gap: 2px;">';
                
                berData.history.slice(-40).forEach(point => {
                    if (point.ber >= threshold) {
                        if (point.ber < 1e-12) {
                            html += '<span style="color: #2ecc71;">â–ˆ</span>';
                        } else if (point.ber < 1e-10) {
                            html += '<span style="color: #f39c12;">â–ˆ</span>';
                        } else {
                            html += '<span style="color: #e74c3c;">â–ˆ</span>';
                        }
                    } else {
                        html += '<span style="color: #34495e;">â–‘</span>';
                    }
                });
                
                html += `<span style="margin-left: 10px; font-size: 10px;">
                        ${threshold.toExponential(1)}</span>`;
                html += '</div>';
            }
            
            html += '<div style="margin-top: 10px; border-top: 1px solid #7f8c8d; padding-top: 10px;">';
            html += 'æ—¶é—´è½´ (æœ€è¿‘40ç§’) â†’';
            html += '</div>';
            
            html += '</div>';
            
            viz.innerHTML = html;
        }

        // ==================== IDLE Detection ====================
        function startIDLEDetection() {
            resetIDLE();
            idleData.detected = false;
            
            idleInterval = setInterval(() => {
                generateIDLEStream();
                updateIDLEStatus();
            }, 300);
        }

        function generateIDLEStream() {
            const viz = document.getElementById('idleViz');
            idleData.blocks = [];
            
            // éšæœºç”ŸæˆIDLEå’Œæ•°æ®å—
            for (let i = 0; i < 30; i++) {
                const rand = Math.random();
                let blockType;
                
                if (rand < 0.6) {
                    blockType = 'IDLE';
                    idleData.consecutiveCount++;
                    idleData.totalCount++;
                } else {
                    blockType = 'DATA';
                    if (idleData.consecutiveCount >= 16 && !idleData.detected) {
                        idleData.detected = true;
                    }
                    idleData.consecutiveCount = 0;
                }
                
                idleData.blocks.push(blockType);
            }
            
            // æ¸²æŸ“
            let html = '<div class="bit-stream">';
            idleData.blocks.forEach((type, idx) => {
                const className = type === 'IDLE' ? 'idle' : 'data';
                html += `<div class="bit ${className}" 
                         style="width: 60px; font-size: 11px;">
                         ${type}
                         </div>`;
            });
            html += '</div>';
            
            if (idleData.detected) {
                html += `<div style="color: #2ecc71; margin-top: 20px; font-size: 18px;">
                         âœ“ IDLEæ£€æµ‹æˆåŠŸ! å·²è¿ç»­æ¥æ”¶${idleData.consecutiveCount}ä¸ªIDLE
                         </div>`;
            } else {
                html += `<div style="color: #f39c12; margin-top: 20px;">
                         æ£€æµ‹ä¸­... å½“å‰è¿ç»­IDLE: ${idleData.consecutiveCount}
                         </div>`;
            }
            
            viz.innerHTML = html;
        }

        function sendDataFrames() {
            // æ¨¡æ‹Ÿå‘é€æ•°æ®å¸§ï¼Œå‡å°‘IDLE
            idleData.consecutiveCount = 0;
            idleData.detected = false;
        }

        function sendIDLEOnly() {
            // æ¨¡æ‹Ÿåªå‘é€IDLE
            idleData.consecutiveCount += 20;
            if (idleData.consecutiveCount >= 16) {
                idleData.detected = true;
            }
            idleData.totalCount += 20;
        }

        function updateIDLEStatus() {
            document.getElementById('idleDetected').textContent = 
                idleData.detected ? 'âœ“ å·²æ£€æµ‹' : 'æœªæ£€æµ‹';
            document.getElementById('consecutiveIdle').textContent = 
                idleData.consecutiveCount;
            document.getElementById('totalIdle').textContent = 
                idleData.totalCount;
            document.getElementById('errorIdle').textContent = 
                idleData.errorCount;
            
            const statusItem = document.querySelectorAll('#idleStatus .status-item')[0];
            if (idleData.detected) {
                statusItem.classList.add('success');
            } else {
                statusItem.classList.remove('success');
            }
        }

        function resetIDLE() {
            clearInterval(idleInterval);
            idleData = {
                detected: false,
                consecutiveCount: 0,
                totalCount: 0,
                errorCount: 0,
                blocks: []
            };
            
            document.getElementById('idleViz').innerHTML = 
                '<div style="color: #00ff00;">ç­‰å¾…å¼€å§‹IDLEæ£€æµ‹...</div>';
            updateIDLEStatus();
            
            // æ¸…é™¤çŠ¶æ€æ ·å¼
            document.querySelectorAll('#idleStatus .status-item').forEach(item => {
                item.classList.remove('success');
            });
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initLaneDisplay();
            
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            document.querySelectorAll('.section').forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    section.style.transition = 'all 0.5s ease';
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                stopAllAnimations();
            }
        });
    </script>
</body>
</html>